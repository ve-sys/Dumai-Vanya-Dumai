import DB
import disnake
from disnake.ext import commands
import random
token=open("–ò–Ω—Ñ–∞ –ø—Ä–æ –±–æ—Ç–∞.txt").readline()[6:]
bot = commands.Bot(command_prefix='$', help_command=None, intents=disnake.Intents.all())
pseudotheme = ['1.–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –æ—Ç —Ä–∞–∫–∞. –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏) @–ê–¥–º–∏–Ω',
                       '2.–°–ø–∞—Å–µ–Ω–∏–µ —Å–∏–±–∏—Ä—Å–∫–æ–≥–æ —Ä–æ–∫–∞. –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏) @–ê–¥–º–∏–Ω',
                       '3.–í–µ—á–Ω—ã–π –¥–≤–∏–≥–∞—Ç–µ–ª—å. –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏) @–ê–¥–º–∏–Ω',
                       '1.–ü–µ—Ç—É–Ω–∏–∏. –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏) @–ê–¥–º–∏–Ω',
                       '2.–°–ª–æ–≤–∞—Ä—å –¥–ª—è 5 –∫–ª–∞—Å—Å–∞. –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏) @–ê–¥–º–∏–Ω',
                       '3.–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–¥–∏ –∏–≥—Ä. –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏) @–ê–¥–º–∏–Ω']
prfl= ["–ë–∏–æ—Ö–∏–º","–°–æ—Ü—ç–∫–æ–Ω–æ–º","–§–∏–∑–º–∞—Ç"]
sprfl=['ü¶†','üìã','üî©']
eprfl=['üß¨','üìà','‚öôÔ∏è']
@bot.event
async def on_ready():
    print(f"Device {bot.user} is set and ready to go")
    game = disnake.Game("—Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö")
    await bot.change_presence(status=disnake.Status.online, activity=game)
    global guild
    guild = bot.guilds[0]
    global basedstrE
    global basedstrS
    basedstrE = '–û—Ç–ª–∏—á–Ω–æ!\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ç–µ–º—ã –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ \n–û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'
    basedstrS = '–ó–∞–¥–∞—á–∞ —ç—Ç–æ–≥–æ –±–æ—Ç–∞ - –¥–∞—Ç—å –≤–∞–º —Ç–µ–º—É –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞.\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–æ–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ—Å—Ç–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç'
    for i in range(len(prfl)):
            basedstrE += f'\n{eprfl[i]} - {prfl[i]}'
            basedstrS += f'\n{sprfl[i]} - {prfl[i]}'
@bot.event
async def on_message(message):
    print(f'{message.author}|{message.author.id}|{message.content}:')
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–∞–∫–µ
    if message.author != bot.user:
        if message.content.startswith('init'):
            mess = '–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º!\n–ù–∞–∂–º–∏—Ç–µ\n\n‚ùî - –ï—Å–ª–∏ –≤—ã –∏—â–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞' \
               '\nüéØ - –ï—Å–ª–∏ –≤—ã –≥–æ—Ç–æ–≤—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É'
            msg = await message.channel.send(mess)
            await msg.add_reaction('‚ùî')
            await msg.add_reaction('üéØ')
            print(f'{message.author}|{message.author.id}|{message.content}:')
        global guild
        uroles = []
        for x in (guild.get_member(message.author.id).roles):
            uroles.append(x.name)
        if message.content.startswith('!–ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–º—É'):
            global pseudotheme
            if "–°–æ–∑–¥–∞—Ç–µ–ª–∏ —Ç–µ–º" in uroles:
                msg = message.content
                for h in range(1, len(uroles)):
                    if uroles[h] in prfl:
                        prf=uroles[h]
                await message.channel.send(DB.addtheme(msg, message.author.id, prf))
            elif "–ò—â—É—â–∏–µ —Ç–µ–º" in uroles:
                await message.channel.send('–í–∞–º –Ω–µ –ø–æ–ª–æ–∂–µ–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ–º—É')
        if message.content.startswith('!—É–¥–∞–ª–∏—Ç—å —Ç–µ–º—É'):
            if "–°–æ–∑–¥–∞—Ç–µ–ª–∏ —Ç–µ–º" in uroles:
                msg = message.content
                await message.channel.send(DB.removetheme(msg, message.author.id))
            elif "–ò—â—É—â–∏–µ —Ç–µ–º" in uroles:
                await message.channel.send('–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø–∏—à–∏—Ç–µ –≤ –∞–¥–º–∏–Ω—É')
        if message.content.startswith('!–º–æ–∏ —Ç–µ–º—ã'):
            await message.channel.send(DB.mytheme(message.author.id))
        if message.content.startswith('!–æ—Ç–ø–∏—Å–∞—Ç—å—Å—è'):
            tema=message.content.replace("!–æ—Ç–ø–∏—Å–∞—Ç—å—Å—è ","",1)
            await message.author.send(DB.follow(tema, message.author.id, False))

@bot.event
async def on_raw_reaction_add(date):
    global guild
    print('+' + str(date.emoji))
    # –í—ã–¥–∞–µ—Ç—Å—è —Ä–æ–ª—å –∏—â—É—â–µ–≥–æ –∏–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞—é—â–µ–≥–æ
    member = guild.get_member(date.user_id)
    if member != bot.user:
        uroles = []
        for x in (member.roles):
            uroles.append(x.name)
        if str(date.emoji) == 'üéØ':
            role = disnake.utils.get(guild.roles, name="–°–æ–∑–¥–∞—Ç–µ–ª–∏ —Ç–µ–º")
            role2 = disnake.utils.get(guild.roles, name="–ò—â—É—â–∏–µ —Ç–µ–º")
            print(guild, member)
            await member.add_roles(role)
            await member.remove_roles(role2)
            global prfl
            for i in uroles:
                if i in prfl:
                    Role = disnake.utils.get(guild.roles, name=i)
                    await member.remove_roles(Role)
            global basedstrE
            mess = basedstrE
            msg = await member.send(mess)
            await msg.add_reaction('üß¨')
            await msg.add_reaction('‚öôÔ∏è')
            await msg.add_reaction('üìà')
        if str(date.emoji) == '‚ùî':
            role = disnake.utils.get(guild.roles, name="–ò—â—É—â–∏–µ —Ç–µ–º")
            role2 = disnake.utils.get(guild.roles, name="–°–æ–∑–¥–∞—Ç–µ–ª–∏ —Ç–µ–º")
            print(guild, member)
            await member.add_roles(role)
            await member.remove_roles(role2)
            global basedstrS
            mess = basedstrS
            msg = await member.send(mess)
            await msg.add_reaction('ü¶†')
            await msg.add_reaction('üî©')
            await msg.add_reaction('üìã')
        print(uroles)
        # –í—ã–¥–∞–µ—Ç—Å—è —Ä–æ–ª—å –ë–∏–æ—Ö–∏–º/–§–∏–∑–º–∞—Ç/–°–æ—Ü—ç–∫ –ø—Ä–µ–¥–ª–∞–≥–∞—é—â–µ–º—É (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω)
        global pseudotheme
        global eprfl
        global sprfl
        if str(date.emoji) in eprfl and member != bot.user and "–°–æ–∑–¥–∞—Ç–µ–ª–∏ —Ç–µ–º" in uroles:
            print(guild, member)
            for l in eprfl:
                if str(date.emoji) == l:
                    role = disnake.utils.get(guild.roles, name=prfl[eprfl.index(str(date.emoji))])
                    await member.add_roles(role)
                    mess = f'–ò—Ç–∞–∫, –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å -{prfl[eprfl.index(str(date.emoji))]}\n–ß—Ç–æ–±—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–º—É –Ω–∞–ø–∏—à–∏—Ç–µ "!–ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–µ–º—É"'
                    await member.send(mess)
                    print(l + "send", prfl[eprfl.index(str(date.emoji))])
                else:
                    role2 = disnake.utils.get(guild.roles, name=prfl[eprfl.index(l)])
                    await member.remove_roles(role2)
                    print(l + "los")
                print(member.roles)
        # –í—ã–¥–∞–µ—Ç—Å—è —Ä–æ–ª—å –ë–∏–æ—Ö–∏–º/–§–∏–∑–º–∞—Ç/–°–æ—Ü—ç–∫ –∏—â—É—â–µ–º—É (–≤–æ–∑–º–æ–∂–µ–Ω –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä)
        if "–ò—â—É—â–∏–µ —Ç–µ–º" in uroles and str(date.emoji) in sprfl:
            role = disnake.utils.get(guild.roles, name=prfl[sprfl.index(str(date.emoji))])
            print(guild, member)
            await member.add_roles(role)
            mess = '–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é —Ç–µ–º—É –Ω–∞–∂–º–∏—Ç–µ üîÑ'
            msg = await member.send(mess)
            await msg.add_reaction('üîÑ')
        # –í—ã–¥–∞—á–∞ —Ç–µ–º—ã –∏—â—É—â–µ–º—É
        if str(date.emoji) == 'üîÑ':
            if len(uroles) > 2:
                prf = []
                for h in uroles:
                    if h in prfl:
                        prf.append(h)
                tema = DB.gettema(prf,date.user_id)
                print("–î–µ–±–∞–≥ –±–∞–∑—ã")
                #1 –∫—Ä–∏—Ç–µ—Ä–∏–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                min_view=min([int(x[3]) for x in tema])
                print(min_view)
                #2 –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å–∫–≤–æ –∞–≤—Ç–æ—Ä–æ–≤ –¥–ª—è —Ç–µ–º –≥–¥–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Ä–∞–≤–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É
                max_authors=max([x[1].count("@") for x in tema if int(x[3])==min_view])
                print(max_authors)
                #3 –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ–ª–æ–≤–µ—Ä–æ–≤ –¥–ª—è —Ç–µ–º –≥–¥–µ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ—Ä–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É
                min_follow=min([x[2].count("@") for x in tema if int(x[3])==min_view and x[1].count("@")==max_authors])
                print(min_follow)
                #4 –º–∞—Å—Å–∏–≤ –Ω–∞ –≤—ã—Ö–æ–¥ —Å–æ—Å—Ç–æ—è—â–∏–π –∏–∑ –∫–æ—Ä—Ç–µ–∂–µ–π —Å—Ç—Ä–æ–∫ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏—Ö —É—Å–ª–æ–≤–∏—é: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —Ä–∞–≤–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ—Ä–æ–≤ —Ä–∞–≤–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ–ª–ª–æ–≤–µ—Ä–æ–≤ —Ä–∞–≤–Ω–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É
                out=[x for x in tema if int(x[3])==min_view and x[1].count("@")==max_authors and x[2].count("@")==min_follow]
                # —Ä–∞–Ω–¥–æ–º –∏–∑ —Ç–æ–≥–æ —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å
                mess = random.choice(out)
                #+ –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É
                DB.record(mess[0])
                # –≤—ã–≤–æ–¥
                msg = await member.send(mess[0]+" –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏):"+mess[1][2:])
                await msg.add_reaction('üîÑ')
                await msg.add_reaction('‚úÖ')
        if str(date.emoji) == '‚úÖ' and "–ò—â—É—â–∏–µ —Ç–µ–º" in uroles:
            channel=await member.create_dm()
            msg=await channel.fetch_message(date.message_id)
            out=msg.content[:msg.content.index(" –ü—Ä–µ–¥–ª–æ–∂–∏–ª(–∏):")]
            print(out)
            await member.send(DB.follow(out,date.user_id,True))
@bot.event
async def on_raw_reaction_remove(date):
    global guild
    member = guild.get_member(date.user_id)
    uroles = []
    for x in (member.roles):
        uroles.append(x.name)
    print(uroles)
    print('-' + str(date.emoji))
    if member != bot.user:
        if str(date.emoji) == 'üéØ' and "–ò—â—É—â–∏–µ —Ç–µ–º" in uroles:
            role = disnake.utils.get(guild.roles, name="–°–æ–∑–¥–∞—Ç–µ–ª–∏ —Ç–µ–º")
            print(guild, member)
            await member.remove_roles(role)
        if str(date.emoji) == '‚ùî' and "–°–æ–∑–¥–∞—Ç–µ–ª–∏ —Ç–µ–º" in uroles:
            role = disnake.utils.get(guild.roles, name="–ò—â—É—â–∏–µ —Ç–µ–º")
            print(guild, member)
            await member.remove_roles(role)
        if str(date.emoji) == 'üß¨' or str(date.emoji) == 'ü¶†':
            role = disnake.utils.get(guild.roles, name="–ë–∏–æ—Ö–∏–º")
            print(guild, member)
            await member.remove_roles(role)
        if str(date.emoji) == '‚öôÔ∏è' or str(date.emoji) == 'üî©':
            role = disnake.utils.get(guild.roles, name="–§–∏–∑–º–∞—Ç")
            print(guild, member)
            await member.remove_roles(role)
        if str(date.emoji) == 'üìà' or str(date.emoji) == 'üìã':
            role = disnake.utils.get(guild.roles, name="–°–æ—Ü—ç–∫–æ–Ω–æ–º")
            print(guild, member)
            await member.remove_roles(role)
        if str(date.emoji) == '‚úÖ' and "–ò—â—É—â–∏–µ —Ç–µ–º" in uroles:
            channel=await member.create_dm()
            msg=await channel.fetch_message(date.message_id)
            await member.send(DB.follow(msg.content,date.user_id,False))
bot.run(token)
